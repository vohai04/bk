@page
@model BookInfoFinder.Pages.NotificationsModel
@{
    ViewData["Title"] = "Thông báo";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Thông báo</h3>
        <div>
            <a class="btn btn-sm btn-outline-secondary" href="/">Quay lại</a>
        </div>
    </div>

    <div id="notificationsContainer">
        <div id="notificationsList" class="list-group"></div>
        <div class="mt-3 d-flex justify-content-center">
            <ul id="notificationsPager" class="pagination"></ul>
        </div>
    </div>

@section Scripts {
    <script>
        (function () {
            const pageSize = 10;
            function renderNotificationItem(obj) {
                const n = obj.notification;
                const target = obj.targetUrl || '#';
                const created = n.createdAt ? new Date(n.createdAt).toLocaleString() : '';
                const isNew = !n.isRead;
                return `
                    <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-start" href="${target}">
                        <div>
                            <div class="fw-bold">${(n.title || '').replace(/</g, '&lt;')}</div>
                            <div class="text-muted small">${(n.message || '').replace(/</g, '&lt;')}</div>
                        </div>
                        <div class="text-end">
                            <div class="small text-muted">${created}</div>
                            ${isNew ? '<span class="badge bg-primary">Mới</span>' : ''}
                        </div>
                    </a>`;
            }

            function fetchPage(page) {
                const url = `/Notifications?handler=Page&page=${page}&pageSize=${pageSize}`;
                const $list = $('#notificationsList');
                $list.html('<div class="text-center p-3">Đang tải...</div>');
                // Use jQuery so session cookies are sent reliably
                $.getJSON(url)
                    .done(function (data) {
                        console.log('Notifications page data', data);
                        const items = data.items || [];
                        const total = data.total || 0;
                        if (!items.length) {
                            $list.html('<div class="alert alert-info">Bạn chưa có thông báo nào.</div>');
                        } else {
                            $list.empty();
                            for (let i = 0; i < items.length; i++) {
                                $list.append(renderNotificationItem(items[i]));
                            }
                        }

                        const totalPages = Math.max(1, Math.ceil(total / pageSize));
                        renderPagination('#notificationsPager', totalPages, page, function (p) { fetchPage(p); });
                    })
                    .fail(function (jqxhr, status, err) {
                        console.error('Failed to load notifications page', status, err);
                        $('#notificationsList').html('<div class="alert alert-danger">Lỗi khi tải thông báo.</div>');
                    });
            }

            // initial load
            $(function () { fetchPage(1); });
        })();
    </script>
}
</div>
