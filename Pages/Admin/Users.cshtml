@page
@model BookInfoFinder.Pages.Admin.UsersModel
@{
    ViewData["Title"] = "Qu·∫£n l√Ω ng∆∞·ªùi d√πng";
    ViewData["Icon"] = "bi bi-people";
    ViewData["Description"] = "Qu·∫£n l√Ω t·∫•t c·∫£ t√†i kho·∫£n ng∆∞·ªùi d√πng trong h·ªá th·ªëng";
}
 
<div class="admin-form-wrapper">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4><i class="bi bi-people"></i> Danh s√°ch ng∆∞·ªùi d√πng</h4>
        <button type="button" class="btn btn-admin-success btn-lg" data-bs-toggle="modal" data-bs-target="#addUserModal">
            <i class="bi bi-person-plus"></i> Th√™m ng∆∞·ªùi d√πng
        </button>
    </div>
    
    <!-- Search and Filter Section - More Spacious -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <h6 class="card-title mb-3"><i class="bi bi-funnel"></i> B·ªô l·ªçc v√† t√¨m ki·∫øm</h6>
                    <form id="searchForm" class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">T√¨m ki·∫øm</label>
                            <input type="text" id="searchInput" name="search" class="form-control admin-form-control" placeholder="T√™n ƒëƒÉng nh·∫≠p, h·ªç t√™n ho·∫∑c email..." />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Tr·∫°ng th√°i</label>
                            <select id="statusFilter" name="status" class="form-select admin-form-control">
                                <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                                <option value="1">Ho·∫°t ƒë·ªông</option>
                                <option value="0">T·∫°m kh√≥a</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Quy·ªÅn</label>
                            <select id="roleFilter" name="role" class="form-select admin-form-control">
                                <option value="">T·∫•t c·∫£ quy·ªÅn</option>
                                <option value="User">User</option>
                                <option value="Admin">Admin</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <div class="d-flex gap-2 w-100">
                                <button type="submit" class="btn btn-admin-primary flex-fill">
                                    <i class="bi bi-search"></i>
                                </button>
                                <a href="/Admin/Users" class="btn btn-admin-secondary" title="Reset">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Table Section - More Spacious -->
<div class="card border-0 shadow-sm">
    <div class="card-header bg-light border-0 py-3">
        <h6 class="mb-0"><i class="bi bi-table"></i> Danh s√°ch ng∆∞·ªùi d√πng</h6>
    </div>
    <div class="card-body p-0">
        <div id="userTableContainer" class="table-responsive">
            <!-- Table content will be loaded here -->
        </div>
    </div>
    
    <div class="card-footer bg-light border-0">
        <nav id="paginationNav" class="d-flex justify-content-center">
            <ul class="pagination mb-0"></ul>
        </nav>
    </div>
</div>

<!-- Modal Th√™m ng∆∞·ªùi d√πng -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form id="addUserForm" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addUserModalLabel">
                    <i class="bi bi-person-plus"></i> Th√™m ng∆∞·ªùi d√πng m·ªõi
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">T√™n ƒëƒÉng nh·∫≠p *</label>
                    <input type="text" name="UserName" class="form-control" placeholder="T√™n ƒëƒÉng nh·∫≠p" required maxlength="30" />
                </div>
                <div class="mb-3">
                    <label class="form-label">H·ªç v√† t√™n *</label>
                    <input type="text" name="FullName" class="form-control" placeholder="H·ªç v√† t√™n" required maxlength="50" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Email *</label>
                    <input type="email" name="Email" class="form-control" placeholder="Email" required maxlength="50" />
                </div>
                <div class="mb-3">
                    <label class="form-label">M·∫≠t kh·∫©u *</label>
                    <input type="password" name="Password" class="form-control" placeholder="M·∫≠t kh·∫©u" required maxlength="50" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Quy·ªÅn *</label>
                    <select name="roleStr" class="form-select" required>
                        <option value="">Ch·ªçn quy·ªÅn</option>
                        <option value="User">User</option>
                        <option value="Admin">Admin</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check"></i> Th√™m ng∆∞·ªùi d√πng
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
            </div>
        </form>
    </div>
</div>
 
<!-- Modal S·ª≠a user (Bootstrap 5) -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form id="editUserForm" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">S·ª≠a t√†i kho·∫£n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" name="userId" id="editUserId" />
                <div class="mb-2">
                    <label>T√™n ƒëƒÉng nh·∫≠p</label>
                    <input type="text" name="userName" id="editUserName" class="form-control" required maxlength="30" />
                </div>
                <div class="mb-2">
                    <label>H·ªç t√™n</label>
                    <input type="text" name="fullName" id="editFullName" class="form-control" maxlength="50" />
                </div>
                <div class="mb-2">
                    <label>Email</label>
                    <input type="email" name="email" id="editEmail" class="form-control" required maxlength="50" />
                </div>
                <div class="mb-2">
                    <label>Quy·ªÅn</label>
                    <select name="roleStr" id="editRoleStr" class="form-select" required>
                        <option value="">Ch·ªçn quy·ªÅn</option>
                        <option value="User">User</option>
                        <option value="Admin">Admin</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">üíæ L∆∞u</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
            </div>
        </form>
    </div>
</div>
 
@section Scripts {
    <script>
        $(function () {
            const pageSize = 10;
            let currentPage = 1;
            let currentSearch = "";
            let addModal = null;
            let editModal = null;

            function loadUsers(page = 1) {
                currentPage = page;
                currentSearch = $('#searchInput').val();
                    const statusFilter = $('#statusFilter').val();
                const roleFilter = $('#roleFilter').val();
                
                $.get('/Admin/Users?handler=AjaxSearch', {
                    search: currentSearch,
                    status: statusFilter,
                    role: roleFilter,
                    page: currentPage,
                    pageSize: pageSize
                })
                .done(function (data) {
                    renderUsersTable(data.users);
                    if (data.totalPages > 1) {
                        renderPagination("#paginationNav ul", data.totalPages, currentPage, function(page) {
                            loadUsers(page);
                        });
                    } else {
                        $('#paginationNav ul').empty();
                    }
                })
                .fail(function() {
                    showToast('C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu!', 'error');
                });
            }

            function renderUsersTable(users) {
                let html = '';
                if (!users.length) {
                    html = `<div class="alert alert-warning m-4">
                                <i class="bi bi-exclamation-triangle"></i> 
                                Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng ph√π h·ª£p v·ªõi ƒëi·ªÅu ki·ªán t√¨m ki·∫øm.
                            </div>`;
                    $('#paginationNav').hide();
                } else {
                    $('#paginationNav').show();
                    html += '<table class="table table-hover align-middle mb-0">';
                    html += '<thead class="table-light">' +
                        '<tr>' +
                            '<th class="py-3 px-4" style="width: 80px;">ID</th>' +
                            '<th class="py-3 px-4" style="width: 150px;">T√™n ƒëƒÉng nh·∫≠p</th>' +
                            '<th class="py-3 px-4" style="width: 200px;">Email</th>' +
                            '<th class="py-3 px-4" style="width: 180px;">H·ªç t√™n</th>' +
                            '<th class="py-3 px-4 text-center" style="width: 100px;">Quy·ªÅn</th>' +
                            '<th class="py-3 px-4 text-center" style="width: 120px;">Tr·∫°ng th√°i</th>' +
                            '<th class="py-3 px-4 text-center" style="width: 160px;">Thao t√°c</th>' +
                        '</tr>' +
                        '</thead><tbody>';
                    
                    $.each(users, function (i, u) {
                        // Fix status display - check both lowercase and uppercase
                        let userStatus = u.status !== undefined ? u.status : u.Status;
                        let statusText = userStatus == 1
                            ? '<span class="badge bg-success px-3 py-2">Ho·∫°t ƒë·ªông</span>'
                            : '<span class="badge bg-danger px-3 py-2">T·∫°m kh√≥a</span>';

                        let actionBtn = userStatus == 1
                            ? `<button class="btn btn-sm btn-outline-warning btn-disable me-1" data-id="${u.userId || u.UserId}" title="Kh√≥a t√†i kho·∫£n">
                                    <i class="bi bi-lock"></i> Kh√≥a
                               </button>`
                            : `<button class="btn btn-sm btn-outline-success btn-enable me-1" data-id="${u.userId || u.UserId}" title="K√≠ch ho·∫°t l·∫°i">
                                    <i class="bi bi-unlock"></i> K√≠ch ho·∫°t
                               </button>`;

                        html += '<tr>' +
                            `<td class="py-3 px-4"><strong>#${u.userId || u.UserId}</strong></td>` +
                            `<td class="py-3 px-4">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-person-circle me-2 text-primary"></i>
                                    <span>${u.userName || u.UserName}</span>
                                </div>
                             </td>` +
                            `<td class="py-3 px-4">
                                <small class="text-muted">
                                    <i class="bi bi-envelope me-1"></i>
                                    ${u.email || u.Email}
                                </small>
                             </td>` +
                            `<td class="py-3 px-4">${u.fullName || u.FullName}</td>` +
                            `<td class="py-3 px-4 text-center">
                                <span class="badge ${(u.role || u.Role) === 'Admin' ? 'bg-danger' : 'bg-primary'} px-3 py-2">
                                    ${u.role || u.Role}
                                </span>
                             </td>` +
                            `<td class="py-3 px-4 text-center">${statusText}</td>` +
                            `<td class="py-3 px-4 text-center">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-primary btn-edit me-1"
                                        data-id="${u.userId || u.UserId}" data-name="${u.userName || u.UserName}" data-email="${u.email || u.Email}" 
                                        data-fullname="${u.fullName || u.FullName}" data-role="${u.role || u.Role}" title="S·ª≠a th√¥ng tin">
                                        <i class="bi bi-pencil"></i> S·ª≠a
                                    </button>
                                    ${actionBtn}
                                </div>
                            </td>` +
                            '</tr>';
                    });
                    html += "</tbody></table>";
                }
                $('#userTableContainer').html(html);
            }

            // Th√™m user
            $('#addUserForm').on('submit', function (e) {
                e.preventDefault();
                let userName = $(this).find('[name="UserName"]').val();
                let fullName = $(this).find('[name="FullName"]').val();
                let email = $(this).find('[name="Email"]').val();
                let password = $(this).find('[name="Password"]').val();
                let roleStr = $(this).find('[name="roleStr"]').val();
                
                $.post('/Admin/Users?handler=AjaxAdd', { userName, fullName, email, password, roleStr })
                .done(function (res) {
                    if (res.success) {
                        $('#addUserForm')[0].reset();
                        if (addModal) addModal.hide();
                        showToast("Th√™m t√†i kho·∫£n th√†nh c√¥ng!", "success");
                        loadUsers(1);
                    } else {
                        showToast(res.message || "Th√™m user th·∫•t b·∫°i!", "error");
                    }
                })
                .fail(function() {
                    showToast("C√≥ l·ªói x·∫£y ra khi th√™m user!", "error");
                });
            });

            // S·ª≠a user
            $('#userTableContainer').on('click', '.btn-edit', function () {
                $('#editUserId').val($(this).data('id'));
                $('#editUserName').val($(this).data('name'));
                $('#editFullName').val($(this).data('fullname'));
                $('#editEmail').val($(this).data('email'));
                $('#editRoleStr').val($(this).data('role'));
                if (!editModal) editModal = new bootstrap.Modal(document.getElementById('editUserModal'));
                editModal.show();
            });

            $('#editUserForm').on('submit', function (e) {
                e.preventDefault();
                let userId = $('#editUserId').val();
                let userName = $('#editUserName').val();
                let fullName = $('#editFullName').val();
                let email = $('#editEmail').val();
                let roleStr = $('#editRoleStr').val();
                
                $.post('/Admin/Users?handler=AjaxEdit', {
                    userId, userName, fullName, email, roleStr
                })
                .done(function (res) {
                    if (res.success) {
                        editModal.hide();
                        showToast("C·∫≠p nh·∫≠t t√†i kho·∫£n th√†nh c√¥ng!", "success");
                        loadUsers(currentPage);
                    } else {
                        showToast(res.message || "S·ª≠a user th·∫•t b·∫°i!", "error");
                    }
                })
                .fail(function() {
                    showToast("C√≥ l·ªói x·∫£y ra khi s·ª≠a user!", "error");
                });
            });

            // Kh√≥a/m·ªü kh√≥a user
            $('#userTableContainer').on('click', '.btn-disable, .btn-enable', function () {
                const $btn = $(this);
                const userId = $btn.data('id');
                const isDisable = $btn.hasClass('btn-disable');
                
                showConfirmModal(
                    'X√°c nh·∫≠n thay ƒë·ªïi tr·∫°ng th√°i',
                    isDisable ? "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën kh√≥a t√†i kho·∫£n n√†y?" : "B·∫°n c√≥ mu·ªën k√≠ch ho·∫°t l·∫°i t√†i kho·∫£n n√†y?",
                    function() {
                        const newStatus = isDisable ? 0 : 1;
                        $.post('/Admin/Users?handler=AjaxSetUserStatus', { userId, status: newStatus })
                        .done(function (res) {
                            if (res.success) {
                                showToast("C·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh c√¥ng!", "success");
                                loadUsers(currentPage);
                            } else {
                                showToast("C·∫≠p nh·∫≠t tr·∫°ng th√°i th·∫•t b·∫°i!", "error");
                            }
                        })
                        .fail(function() {
                            showToast("C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t tr·∫°ng th√°i!", "error");
                        });
                    }
                );
            });

            // T√¨m ki·∫øm
            $('#searchForm').on('submit', function (e) {
                e.preventDefault();
                loadUsers(1);
            });

            // Initialize modals
            addModal = new bootstrap.Modal(document.getElementById('addUserModal'));

            // Load m·∫∑c ƒë·ªãnh
            loadUsers(1);
        });
    </script>
}
