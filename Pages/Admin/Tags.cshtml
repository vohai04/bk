@page
@model BookInfoFinder.Pages.Admin.TagsModel
@{
    ViewData["Title"] = "Quản lý tag";
    ViewData["Icon"] = "bi bi-tags-fill";
    ViewData["Description"] = "Quản lý các tag cho sách";
}

<div class="admin-form-wrapper mb-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4><i class="bi bi-tags-fill"></i> Danh sách tag</h4>
        <button type="button" class="btn btn-admin-success" data-bs-toggle="modal" data-bs-target="#addTagModal">
            <i class="bi bi-tag-fill"></i> Thêm tag
        </button>
    </div>
</div>

<div class="admin-form-wrapper mb-4">
    <div class="row g-3">
        <div class="col-md-8">
            <form id="searchTagForm">
                <div class="admin-form-group">
                    <label class="admin-form-label">
                        <i class="bi bi-search"></i>
                        Tìm kiếm tags
                    </label>
                    <div class="input-group">
                        <input type="text" id="searchTagInput" name="search" class="form-control admin-form-control"
                               placeholder="Nhập tên tag cần tìm..." />
                        <button type="submit" class="btn btn-admin-primary">
                            <i class="bi bi-search"></i>
                        </button>
                        <a href="/Admin/Tags" class="btn btn-admin-secondary" title="Reset">
                            <i class="bi bi-arrow-clockwise"></i>
                        </a>
                    </div>
                </div>
            </form>
        </div>
        <div class="col-md-4">
            <div class="admin-alert admin-alert-info p-2">
                <i class="bi bi-info-circle"></i>
                Tổng: <strong id="totalTagsDisplay">0</strong> tags
            </div>
        </div>
    </div>
</div>

<div class="admin-table-wrapper">
    <div id="tagTableContainer">
        <div class="admin-loading">
            <i class="bi bi-arrow-clockwise"></i>
            <span class="ms-2">Đang tải dữ liệu...</span>
        </div>
    </div>
</div>

<nav id="paginationTagNav" class="mt-4">
    <ul class="pagination justify-content-center" id="paginationTagButtons"></ul>
</nav>

<!-- Edit Tag Modal -->
<div class="modal fade" id="editTagModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-pencil"></i>
                    Chỉnh sửa tag
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editTagForm">
                    <input type="hidden" id="editTagId" />
                    <div class="admin-form-group mb-3">
                        <label class="admin-form-label">
                            <i class="bi bi-tag"></i>
                            Tên tag <span class="text-danger">*</span>
                        </label>
                        <input type="text" id="editTagName" class="form-control admin-form-control" 
                               maxlength="30" required placeholder="Nhập tên tag..." />
                    </div>
                    <div class="admin-form-group">
                        <label class="admin-form-label">
                            <i class="bi bi-file-text"></i>
                            Mô tả (tùy chọn)
                        </label>
                        <textarea id="editTagDescription" class="form-control admin-form-control" 
                                  rows="3" maxlength="200" placeholder="Mô tả chi tiết về tag..."></textarea>
                        <div class="form-text">Tối đa 200 ký tự</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-admin-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i>
                    Hủy
                </button>
                <button type="button" class="btn btn-admin-success" id="saveEditTag">
                    <i class="bi bi-check-circle"></i>
                    Lưu thay đổi
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(function () {
            const pageSize = 10;
            let currentPage = 1;

            function loadTags(page = 1) {
                currentPage = page;
                const currentSearch = $('#searchTagInput').val();

                // Show loading
                $('#tagTableContainer').html(`
                    <div class="admin-loading">
                        <i class="bi bi-arrow-clockwise"></i>
                        <span class="ms-2">Đang tải dữ liệu...</span>
                    </div>
                `);

                $.get('/Admin/Tags?handler=AjaxSearch', {
                    search: currentSearch,
                    page: currentPage,
                    pageSize: pageSize
                })
                .done(function (data) {
                    renderTagsTable(data.tags);
                    renderPagination('#paginationTagButtons', data.totalPages, currentPage, loadTags);
                    $('#totalTagsDisplay').text(data.totalCount || data.tags.length);
                })
                .fail(function() {
                    $('#tagTableContainer').html(`
                        <div class="admin-alert admin-alert-danger">
                            <i class="bi bi-exclamation-triangle"></i>
                            Có lỗi xảy ra khi tải dữ liệu. Vui lòng thử lại.
                        </div>
                    `);
                });
            }

            function renderTagsTable(tags) {
                let html = '';
                
                if (!tags || tags.length === 0) {
                    html = `
                        <div class="text-center p-5">
                            <i class="bi bi-tags" style="font-size: 4rem; color: #6c757d;"></i>
                            <h5 class="mt-3 text-muted">Không tìm thấy tag nào</h5>
                            <p class="text-muted">Không có tag nào phù hợp với từ khóa tìm kiếm.</p>
                            <a href="/Admin/Tags" class="btn btn-admin-primary">
                                <i class="bi bi-arrow-clockwise"></i>
                                Reset bộ lọc
                            </a>
                        </div>
                    `;
                    $('#paginationTagNav').hide();
                } else {
                    $('#paginationTagNav').show();
                    html = `
                        <table class="table admin-table">
                            <thead>
                                <tr>
                                    <th style="width: 80px;">
                                        <i class="bi bi-hash"></i>
                                        ID
                                    </th>
                                    <th style="width: 200px;">
                                        <i class="bi bi-tag"></i>
                                        Tên tag
                                    </th>
                                    <th>
                                        <i class="bi bi-file-text"></i>
                                        Mô tả
                                    </th>
                                    <th style="width: 120px;">
                                        <i class="bi bi-book"></i>
                                        Số sách
                                    </th>
                                    <th style="width: 150px;">
                                        <i class="bi bi-calendar"></i>
                                        Ngày tạo
                                    </th>
                                    <th style="width: 150px;">
                                        <i class="bi bi-gear"></i>
                                        Thao tác
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    tags.forEach(function(tag) {
                        const createdDate = tag.createdAtFormatted || 'N/A';
                        const description = tag.description || '';
                        const displayDescription = description.length > 50 ? description.substring(0, 50) + '...' : description;
                        
                        html += `
                            <tr data-id="${tag.tagId}">
                                <td>
                                    <span class="badge" style="background: var(--admin-primary);">${tag.tagId}</span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-secondary me-2">
                                            <i class="bi bi-tag-fill"></i>
                                        </span>
                                        <strong>${tag.name}</strong>
                                    </div>
                                </td>
                                <td>
                                    <small class="text-muted" title="${description}">${displayDescription || '<em>Chưa có mô tả</em>'}</small>
                                </td>
                                <td>
                                    <span class="badge ${tag.bookCount > 0 ? 'bg-success' : 'bg-secondary'}">
                                        ${tag.bookCount || 0} sách
                                    </span>
                                </td>
                                <td>
                                    <small class="text-muted">${createdDate}</small>
                                </td>
                                <td>
                                    <div class="admin-action-buttons">
                                        <button class="btn btn-warning btn-admin-sm btn-edit" 
                                                data-id="${tag.tagId}" 
                                                data-name="${tag.name.replace(/"/g, '&quot;')}"
                                                data-description="${description.replace(/"/g, '&quot;')}"
                                                data-bs-toggle="tooltip" 
                                                title="Chỉnh sửa tag">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-admin-danger btn-admin-sm btn-delete" 
                                                data-id="${tag.tagId}"
                                                data-name="${tag.name.replace(/"/g, '&quot;')}"
                                                data-book-count="${tag.bookCount || 0}"
                                                data-bs-toggle="tooltip" 
                                                title="Xóa tag">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });

                    html += `
                            </tbody>
                        </table>
                    `;
                }
                
                $('#tagTableContainer').html(html);
                initTooltips();
            }

            // Thêm tag
            $('#addTagForm').on('submit', function (e) {
                e.preventDefault();
                const name = $(this).find('input[name="Name"]').val().trim();
                const description = $(this).find('textarea[name="Description"]').val().trim();
                
                if (!name) {
                    showToast('Vui lòng nhập tên tag!', 'warning');
                    return;
                }

                const submitBtn = $(this).find('button[type="submit"]');
                const originalText = submitBtn.html();
                submitBtn.prop('disabled', true).html('<i class="bi bi-arrow-clockwise"></i> Đang xử lý...');

                $.post('/Admin/Tags?handler=AjaxAdd', { name, description })
                .done(function (res) {
                    if (res.success) {
                        $('#addTagForm')[0].reset();
                        $('#addTagModal').modal('hide');
                        loadTags(1);
                        showToast('Thêm tag thành công!', 'success');
                    } else {
                        showToast(res.message || 'Thêm tag thất bại!', 'danger');
                    }
                })
                .fail(function() {
                    showToast('Có lỗi xảy ra khi thêm tag!', 'danger');
                })
                .always(function() {
                    submitBtn.prop('disabled', false).html(originalText);
                });
            });

            // Mở modal chỉnh sửa tag
            $('#tagTableContainer').on('click', '.btn-edit', function () {
                const tagId = $(this).data('id');
                const tagName = $(this).data('name');
                const tagDescription = $(this).data('description');
                
                $('#editTagId').val(tagId);
                $('#editTagName').val(tagName);
                $('#editTagDescription').val(tagDescription);
                
                $('#editTagModal').modal('show');
            });

            // Lưu chỉnh sửa tag
            $('#saveEditTag').on('click', function () {
                const tagId = $('#editTagId').val();
                const newName = $('#editTagName').val().trim();
                const newDescription = $('#editTagDescription').val().trim();
                
                if (!newName) {
                    showToast('Tên tag không được để trống!', 'warning');
                    return;
                }

                const btn = $(this);
                const originalText = btn.html();
                btn.prop('disabled', true).html('<i class="bi bi-arrow-clockwise"></i> Đang lưu...');

                $.post('/Admin/Tags?handler=AjaxEdit', { 
                    tagId: tagId, 
                    name: newName, 
                    description: newDescription 
                })
                .done(function (res) {
                    if (res.success) {
                        $('#editTagModal').modal('hide');
                        loadTags(currentPage);
                        showToast('Cập nhật tag thành công!', 'success');
                    } else {
                        showToast(res.message || 'Cập nhật tag thất bại!', 'danger');
                    }
                })
                .fail(function() {
                    showToast('Có lỗi xảy ra khi cập nhật tag!', 'danger');
                })
                .always(function() {
                    btn.prop('disabled', false).html(originalText);
                });
            });

            // Xóa tag
            $('#tagTableContainer').on('click', '.btn-delete', function () {
                const tagId = $(this).data('id');
                const tagName = $(this).data('name');
                const bookCount = $(this).data('book-count');
                
                let confirmMessage = `Bạn có chắc chắn muốn xóa tag "${tagName}"?`;
                if (bookCount > 0) {
                    confirmMessage += `\n\nCảnh báo: Tag này đang được sử dụng bởi ${bookCount} cuốn sách!`;
                }
                confirmMessage += '\n\nHành động này không thể hoàn tác!';
                
                showConfirmModal(
                    'Xác nhận xóa tag',
                    confirmMessage,
                    'danger',
                    () => {
                        const btn = $(this);
                        const originalHtml = btn.html();
                        btn.prop('disabled', true).html('<i class="bi bi-arrow-clockwise"></i>');

                        $.post('/Admin/Tags?handler=AjaxDelete', { tagId })
                        .done(function (res) {
                            if (res.success) {
                                loadTags(currentPage);
                                showToast(`Đã xóa tag "${tagName}" thành công!`, 'success');
                            } else {
                                showToast(res.message || 'Xóa tag thất bại!', 'danger');
                            }
                        })
                        .fail(function() {
                            showToast('Có lỗi xảy ra khi xóa tag!', 'danger');
                        })
                        .always(function() {
                            btn.prop('disabled', false).html(originalHtml);
                        });
                    }
                );
            });

            // Tìm kiếm
            $('#searchTagForm').on('submit', function (e) {
                e.preventDefault();
                loadTags(1);
            });

            // Load dữ liệu ban đầu
            loadTags(1);
        });
    </script>
}

<!-- Modal Thêm tag -->
<div class="modal fade" id="addTagModal" tabindex="-1" aria-labelledby="addTagModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form id="addTagForm" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addTagModalLabel">
                    <i class="bi bi-tag-fill"></i> Thêm tag mới
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Tên tag *</label>
                    <input type="text" name="Name" class="form-control" placeholder="Nhập tên tag..." required maxlength="30" />
                    <div class="form-text">Tối đa 30 ký tự, sử dụng cho việc phân loại và tìm kiếm sách</div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Mô tả</label>
                    <textarea name="Description" class="form-control" placeholder="Mô tả ngắn về tag..." maxlength="200" rows="3"></textarea>
                    <div class="form-text">Tối đa 200 ký tự, giúp mô tả chi tiết về tag</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check"></i> Thêm tag
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
            </div>
        </form>
    </div>
</div>
